<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Registros - TECHO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Fredoka:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f9f9f9;
    }
    h1, .btn, .form-label {
      font-family: 'Fredoka', sans-serif;
    }
    .estado-caracterizado { background-color: #954B9722; color: #954B97; border-radius: 8px; padding: 4px 8px; }
    .estado-encuestado   { background-color: #0092DD22; color: #0092DD; border-radius: 8px; padding: 4px 8px; }
    .estado-preasignado  { background-color: #FDC53322; color: #FDC533; border-radius: 8px; padding: 4px 8px; }
    .estado-asignado     { background-color: #2FAC6622; color: #2FAC66; border-radius: 8px; padding: 4px 8px; }
    .estado-inactivo     { background-color: #E9436222; color: #E94362; border-radius: 8px; padding: 4px 8px; }
    .small-label {
      font-size: 0.8rem;
      color: #666;
    }
    .card:hover {
      background-color: #f0f0f0;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="text-center mb-4">
      <img src="/static/logo.png" alt="Logo" height="80">
      <h1 class="mt-2">Consulta de Registros</h1>
      {% if db_info.last_modified %}
        <p class="small-label">Última sync: {{ db_info.last_modified.strftime('%Y-%m-%d %H:%M:%S') }}</p>
      {% endif %}
    </div>

    <form id="search-form" class="mb-4">
      <div class="row g-2">
        <div class="col-md-4">
          <label for="field" class="form-label">Buscar por</label>
          <select class="form-select" id="field" name="field">
            <option value="CEDULA">CÉDULA</option>
            <option value="CONTACTO 1">CONTACTO (Celular)</option>
            <option value="NOMBRE COMPLETO">NOMBRE</option>
          </select>
        </div>
        <div class="col-md-5">
          <label for="value" class="form-label">Valor</label>
          <input type="text" class="form-control" id="value" name="value" placeholder="Ingrese valor de búsqueda">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Buscar</button>
        </div>
      </div>

      <div class="row g-2 mt-3">
        <div class="col-md-6">
          <label for="comunidad" class="form-label">Filtrar por Comunidad</label>
          <select class="form-select" id="comunidad" name="comunidad">
            <option value="Todas">Todas</option>
            <option value="La Nueva Jerusalén">La Nueva Jerusalén</option>
            <option value="La Honda">La Honda</option>
            <option value="Granizal">Granizal</option>
          </select>
        </div>
        <div class="col-md-6">
          <label for="estado" class="form-label">Filtrar por Estado</label>
          <select class="form-select" id="estado" name="estado">
            <option value="Todos">Todos</option>
            <option value="caracterizado">Caracterizado</option>
            <option value="encuestado">Encuestado</option>
            <option value="preasignado">Preasignado</option>
            <option value="asignado">Asignado</option>
            <option value="inactivo">Inactivo</option>
          </select>
        </div>
      </div>
    </form>

    <div id="recent-searches" class="mb-4"></div>

    <div id="results-container"></div>

    {% if has_unsynced_comments %}
      <div class="alert alert-warning mt-4">
        Hay comentarios sin sincronizar. <a href="/comments">Ver comentarios</a>
      </div>
    {% endif %}

  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $('#search-form').on('submit', function(e) {
      e.preventDefault();
      const data = {
        field: $('#field').val(),
        value: $('#value').val(),
        filters: {
          comunidad: $('#comunidad').val(),
          estado: $('#estado').val()
        }
      };

      $.post({
        url: '/search',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: res => {
          const container = $('#results-container');
          container.empty();
          if (res.results.length === 0) {
            container.append('<p class="text-muted">No se encontraron resultados.</p>');
          } else if (res.results.length > 1 && data.field === 'NOMBRE COMPLETO') {
            res.results.forEach(r => {
              container.append(`
                <div class="card mb-2 p-2" onclick="showDetails(${encodeURIComponent(JSON.stringify(r))})">
                  <strong>${r["NOMBRE COMPLETO"]}</strong><br>
                  <span class="text-muted">${r.COMUNIDAD} | ${r.CEDULA}</span>
                </div>`);
            });
          } else {
            showDetails(res.results[0]);
          }
        },
        error: err => alert('Error en búsqueda')
      });
    });

    function showDetails(record) {
      const estadoColor = record.ESTADO?.toLowerCase();
      const estadoClass = `estado-${estadoColor}`;
      let html = `<div class="card p-3">
        <div class="mb-2"><strong>ESTADO:</strong> <span class="${estadoClass}">${record.ESTADO}</span></div>`;
      for (let key in record) {
        if (key === 'ESTADO') continue;
        html += `<div><strong>${key}:</strong> ${record[key]}</div>`;
      }
      html += `
        <div class="mt-3">
          <textarea class="form-control mb-2" id="comment-box" rows="2" placeholder="Añadir comentario..."></textarea>
          <button class="btn btn-success" onclick='addComment(${JSON.stringify(record)})'>Guardar comentario</button>
        </div>
      </div>`;

      $('#results-container').html(html);
    }

    function addComment(record) {
      const comment = $('#comment-box').val();
      if (!comment) return alert('Comentario vacío');

      $.post({
        url: '/add_comment',
        contentType: 'application/json',
        data: JSON.stringify({ record: record, comment: comment }),
        success: res => {
          alert(res.message || 'Comentario añadido');
          $('#comment-box').val('');
        },
        error: err => alert('Error al guardar el comentario')
      });
    }
  </script>
</body>
</html>
